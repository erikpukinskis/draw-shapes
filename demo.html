<html><body>

<style>
canvas {
  border: 1px solid #eee;
}
</style>
<script src="../build/gl-matrix.js"></script>
<script src="../build/draw-scene.js"></script>

<canvas width="400" height="400" onmousedown="startShape(event)"></canvas>

<script>

var handleMove

var strokes = []

function startShape(event) {
  var stroke = {
    path: [
      [event.clientX, event.clientY]
    ]
  }

  strokes.push(stroke)

  handleMove = addPoint.bind(null, stroke.path)
  handleUp = finishShape.bind(null, stroke.path)
}

function addPoint(path, event) {
  path.push([event.clientX, event.clientY])

  drawStrokes()
}

function drawStrokes() {
  var shapes = []
  strokes.forEach(function(stroke) {
    shapes = shapes.concat(pathToShapes(stroke.path))
  })

  drawScene(shapes)
}

var shapes = []

function finishShape(path, event) {
  handleMove = null
  handleUp = null
}

function pathToShapes(path) {
  var shapes = []

  var last = path.length-1

  var firstPoint = [
    path[0][0], 
    -path[0][1],
    0.0
  ]

  var lastPoint = [
    path[last][0],
    -path[last][1],
    0.0
  ]

  var out = []
  var midPoint = []
  var otherMidPoint = []

  vec3.subtract(out, lastPoint, firstPoint)

  vec3.scale(out, out, 0.5)

  vec3.add(out, firstPoint, out)

  var distance = vec3.distance(firstPoint, lastPoint)

  var thickness = (7 - Math.log(distance)) / 8.0

  vec3.rotateZ(midPoint, out, firstPoint, thickness)

  vec3.rotateZ(otherMidPoint, out, firstPoint, -thickness)

  return [
    triangle(firstPoint, midPoint, lastPoint),
    triangle(firstPoint, otherMidPoint, lastPoint)
  ]
}

function triangle(a,b,c) {
  return {
    position: [0.0, 0.0, 0.0],
    verticies: a.concat(b,c),
    pointCount: 3,
    colors: [
      1.0, 0.4, 0.6, 1.0,
      0.9, 0.4, 0.7, 1.0,
      0.8, 0.4, 0.9, 1.0
    ]
  }

}


var camera = {
  fovy: 45,
  near: 0.1,
  far: 600.0,
  pitch: 0.0,
  yaw: 0.0,
  xPos: -205.0,
  yPos: 205.0,
  zPos: -340.0  
}

drawScene.init(camera)

window.onmousemove = function(event) {
  if (!handleMove) { return }
  handleMove(event)
}

window.onmouseup = function(event) {
  if (!handleUp) { return }
  handleUp(event)
}

</script>

</body></html>